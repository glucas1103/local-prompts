# Database Migrations

## Metadata
- **Category**: Memory
- **Last Update**: 2025-10-20
- **Owner**: CTO (Lucas Gaillard)
- **Status**: Active
- **Source Files**: `apps/api/drizzle/**`

## Migration History

### Migration 0000: Initial Schema
**File**: `drizzle/0000_empty_arclight.sql`  
**Date**: Project initialization  
**Description**: Empty initial migration (placeholder)

---

### Migration 0001: Core Tables
**File**: `drizzle/0001_normal_landau.sql`  
**Date**: Project initialization  
**Description**: 
- Created `users` table
- Created `organizations` table
- Created `organization_members` junction table
- Established foreign key relationships

**Tables Created**:
- `users` (id, email, firstName, lastName, photoUrl, isAdmin, deleted, deletedAt, createdAt, updatedAt)
- `organizations` (id, name, plan, deleted, deletedAt, createdAt, updatedAt)
- `organization_members` (id, organizationId, userId, role, createdAt, updatedAt)

---

### Migration 0002: GitHub Integration
**File**: `drizzle/0002_skinny_magma.sql`  
**Date**: GitHub integration feature  
**Description**:
- Created `github_installations` table
- Created `github_installation_repositories` table
- Linked installations to organizations

**Tables Created**:
- `github_installations` (id, organizationId, createdAt, updatedAt)
- `github_installation_repositories` (id, installationId, name, createdAt, updatedAt)

---

### Migration 0003: [To be documented]
**File**: `drizzle/0003_slippery_dracula.sql`  
**Description**: [To be documented by team]

---

## Migration Workflow

### Creating a Migration

1. **Modify schema** in `apps/api/src/db/schema.ts`
2. **Generate migration**:
   ```bash
   cd apps/api
   npm run db:generate
   ```
3. **Review generated SQL** in `drizzle/` directory
4. **Test migration** on local database
5. **Commit migration files** to git

### Applying Migrations

**Local Development**:
```bash
cd apps/api
npm run db:migrate
```

**Staging/Production**:
```bash
# Apply migrations BEFORE deploying new code
cd apps/api
npm run db:migrate
```

**Fresh Database Setup**:
```bash
cd apps/api
npm run db:init  # Runs migrations + seeds test data
```

### Migration Best Practices

✅ **DO**:
- Review generated SQL before committing
- Test migrations on local database first
- Apply migrations before deploying code changes
- Use descriptive migration names
- Keep migrations small and focused

❌ **DON'T**:
- Edit existing migration files
- Skip migrations in sequence
- Deploy code before applying schema changes
- Mix schema changes with data migrations

### Rollback Strategy

**Manual Rollback**:
1. Create reverse migration manually
2. Test thoroughly
3. Apply in production

**Example**:
```sql
-- Original migration
ALTER TABLE users ADD COLUMN phone VARCHAR(255);

-- Rollback migration
ALTER TABLE users DROP COLUMN phone;
```

**[To be documented by CTO]**: Formal rollback procedures and policies.

---

## Migration Naming Convention

Format: `XXXX_adjective_noun.sql`
- `XXXX`: Sequential number (0000, 0001, 0002, ...)
- Adjective + Noun: Auto-generated by Drizzle

Examples:
- `0001_normal_landau.sql`
- `0002_skinny_magma.sql`
- `0003_slippery_dracula.sql`

---

## Database Management Scripts

Located in `apps/api/db-management/scripts/`:

**dump.sh**: Create database backup
```bash
cd apps/api/db-management/scripts
./dump.sh
```

**restore.sh**: Restore from backup
```bash
cd apps/api/db-management/scripts
./restore.sh
```

**migrate.sh**: Apply migrations
```bash
cd apps/api/db-management/scripts
./migrate.sh
```

**dump-external.sh**: Backup external database
```bash
cd apps/api/db-management/scripts
./dump-external.sh
```

---

## Future Migrations

Document planned schema changes here:

**[Planned]**: [To be documented as needs arise]

---

## References

- **Migrations Directory**: `apps/api/drizzle/`
- **Schema**: `apps/api/src/db/schema.ts`
- **Scripts**: `apps/api/db-management/scripts/`
- **Configuration**: `apps/api/drizzle.config.ts`
